---
- name: Check Last Update and Reboot Times on RHEL Servers
  hosts: balancers
  gather_facts: yes
  tasks:
    - name: Check last update time (RHEL)
      shell: rpm -q --last kernel
      register: last_update
      changed_when: false
      failed_when: false

    - name: Check last reboot time
      shell: uptime -s
      register: last_reboot
      changed_when: false
      failed_when: false

    - name: Calculate update and reboot age
      set_fact:
        current_time: "{{ ansible_date_time.epoch }}"

    - name: Calculate update age
      set_fact:
        update_time: "{{ last_update.stdout | regex_replace('^.*\\s', '') }}"
      when: last_update.stdout is defined

    - name: Calculate reboot age
      set_fact:
        reboot_time: "{{ last_reboot.stdout }}"
      when: last_reboot.stdout is defined

    - name: Display server information
      debug:
        msg: "Server {{ inventory_hostname }} - Last Update Age: {{ (current_time | int - update_time | int) / 86400 | int | default('Not available') }} days ({{ update_time | default('Not available') }}), Last Reboot Age: {{ (current_time | int - reboot_time | int) / 86400 | int | default('Not available') }} days ({{ reboot_time | default('Not available') }})"

